# テスト追加 & リファクタリング TODO

## 🟢 即座にテスト追加（高優先度）

### 1. internal/keymanager ★★★★★
- **理由**: ロジック豊富、GUI非依存、インターフェース設計良好
- **テスト対象**: 
  - [ ] スタック管理（Push/Pop/GetCurrentHandler）
  - [ ] 修飾キー状態管理（Shift/Ctrl検出）
  - [ ] イベントルーティング（KeyDown/KeyUp/TypedKey/TypedRune）
  - [ ] 同期処理（concurrent access）
  - [ ] エラーハンドリング（空スタックでのPop等）
- **アプローチ**: KeyHandler のモック作成、単体テスト
- **見積もり**: 2-3時間

### 2. internal/watcher ★★★★☆
- **理由**: 重要機能、FileManager インターフェース経由で分離済み
- **テスト対象**:
  - [ ] ファイル変更検出ロジック（Added/Modified/Deleted）
  - [ ] goroutine管理（Start/Stop）
  - [ ] チャネル通信（changeChan処理）
  - [ ] タイマー処理（ticker管理）
  - [ ] 同期処理（mutex保護）
- **アプローチ**: FileManager モック、チャネル・タイマーのテスト
- **見積もり**: 3-4時間

## 🟡 軽いリファクタリング後にテスト追加（中優先度）

### 3. internal/theme ★★★☆☆
- **現状**: GetCustomColor等は純粋ロジック、Fyneテーマ実装は密結合
- **リファクタリング案**:
  - [ ] 色計算ロジックを独立関数に分離（`getColorScheme`, `selectColor`等）
  - [ ] フォント読み込み処理を分離（`loadFont`関数）
  - [ ] テーマ切り替えロジックをテスト可能に
- **テスト対象**:
  - [ ] ライト/ダークテーマ切り替え
  - [ ] 色計算ロジック（全色タイプのテスト）
  - [ ] フォントファイル読み込み（存在/非存在）
  - [ ] カスタムサイズ計算
- **見積もり**: 2-3時間

### 4. internal/ui/widgets.go ★★☆☆☆
- **現状**: 状態管理は単純、Widget描画は密結合
- **リファクタリング案**:
  - [ ] イベントハンドラー状態管理を別構造体に分離
  - [ ] タップ処理ロジックを純粋関数化
- **テスト対象**:
  - [ ] タップイベント処理
  - [ ] リソース設定/取得
  - [ ] コールバック管理
- **見積もり**: 1-2時間

## 🔴 大幅リファクタリング必要（低優先度）

### 5. internal/ui/cursor.go ★★☆☆☆
- **問題**: 計算ロジックとCanvas生成が混在
- **大規模リファクタリング**:
  - [ ] 位置・サイズ計算を純粋関数に分離
  - [ ] カーソル描画ロジックと計算ロジックを分離
  - [ ] 各CursorRenderer の計算部分をテスト可能に
- **見積もり**: 4-5時間

### 6. internal/ui/key_sink.go ★☆☆☆☆
- **問題**: Widgetラッパーが主機能、実ロジックはKeyManagerにあり
- **アプローチ**: 
  - [ ] フォーカス管理ロジックの分離を検討
  - [ ] オプション処理のテスト
- **見積もり**: 1-2時間

### 7. internal/ui大型ダイアログ ☆☆☆☆☆
- **問題**: 大量UI要素、複雑イベント処理、Fyne深依存
- **対象ファイル**:
  - [ ] history.go (493行)
  - [ ] tree_dialog.go (482行) 
  - [ ] filter_dialog.go (462行)
  - [ ] sort_dialog.go (397行)
  - [ ] incremental_search.go (309行)
- **アプローチ**: 大幅リファクタリング必要、または統合テストレベル
- **見積もり**: 各ファイル 6-8時間

## 🟢 対象外
- **internal/constants**: 定数定義のみ、テスト不要

## 実装スケジュール

### Phase 1: 高優先度（1週間）
1. [ ] keymanager テスト追加
2. [ ] watcher テスト追加

### Phase 2: 中優先度（1週間）  
3. [ ] theme 軽リファクタ + テスト
4. [ ] widgets 軽リファクタ + テスト

### Phase 3: 低優先度（要検討）
5. [ ] cursor リファクタ + テスト
6. [ ] key_sink テスト
7. [ ] 大型ダイアログ（費用対効果で判断）

## 進捗追跡
- 開始日: 
- Phase 1 完了予定:
- Phase 2 完了予定:

## メモ
- テスト実行: `go test ./internal/...`
- カバレッジ確認: `go test -cover ./internal/...`
- ベンチマーク: `go test -bench=. ./internal/...`